<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#050308">
<title>Objectif.ID ‚Äî Master Library Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:      #080507;
    --panel:   #0e0a12;
    --border:  rgba(212,168,67,0.15);
    --gold:    #D4A843;
    --gold2:   #F0C85A;
    --red:     #9B1B1B;
    --red2:    #c0392b;
    --green:   #1e6b3a;
    --green2:  #27ae60;
    --text:    #e8ddd0;
    --dim:     #7a6a55;
    --input-bg:#0a0710;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html,body { min-height:100%; background:var(--bg); color:var(--text); font-family:'Cormorant Garamond',Georgia,serif; font-size:15px; }

  /* ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ */
  #lockScreen {
    position:fixed; inset:0; background:var(--bg);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:28px; z-index:1000;
    background: radial-gradient(ellipse 80% 70% at 50% 50%, #1a0820 0%, #050308 100%);
  }
  .lock-symbol { font-size:38px; color:var(--gold); opacity:0.6; animation:lock-float 3s ease-in-out infinite; }
  @keyframes lock-float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }
  .lock-title  { font-family:'Cinzel',serif; font-size:14px; letter-spacing:5px; color:var(--gold); opacity:0.8; }
  .lock-sub    { font-size:12px; letter-spacing:2px; color:var(--dim); font-style:italic; }
  .pin-dots    { display:flex; gap:14px; }
  .pin-dot     { width:14px; height:14px; border-radius:50%; border:1.5px solid var(--gold); opacity:0.4; transition:all 0.2s; }
  .pin-dot.filled { background:var(--gold); opacity:1; box-shadow:0 0 10px rgba(212,168,67,0.6); }
  .pin-grid    { display:grid; grid-template-columns:repeat(3,70px); gap:10px; justify-content:center; }
  .pin-btn {
    height:55px; border-radius:8px;
    background:rgba(212,168,67,0.06); border:1px solid var(--border);
    color:var(--gold2); font-family:'Cinzel',serif; font-size:18px; font-weight:600;
    cursor:pointer; transition:all 0.15s; letter-spacing:2px;
  }
  .pin-btn:hover   { background:rgba(212,168,67,0.12); border-color:rgba(212,168,67,0.3); }
  .pin-btn:active  { background:rgba(212,168,67,0.2); transform:scale(0.96); }
  .pin-btn.del-btn { font-size:14px; color:var(--dim); }
  .lock-error { font-family:'Cinzel',serif; font-size:11px; letter-spacing:3px; color:var(--red2); opacity:0; transition:opacity 0.3s; }
  .lock-error.show { opacity:1; }
  .lock-hint { font-size:11px; color:var(--dim); letter-spacing:1px; font-style:italic; opacity:0.6; }

  /* ‚îÄ‚îÄ MAIN APP (hidden until unlocked) ‚îÄ‚îÄ */
  #appScreen { display:none; min-height:100vh; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .app-header {
    position:sticky; top:0; z-index:100;
    background:rgba(8,5,7,0.97); border-bottom:1px solid var(--border);
    padding:14px 20px;
    display:flex; align-items:center; justify-content:space-between;
    backdrop-filter:blur(10px);
  }
  .header-brand { font-family:'Cinzel',serif; font-size:13px; letter-spacing:4px; color:var(--gold); }
  .header-brand span { color:var(--dim); font-size:10px; letter-spacing:2px; display:block; margin-top:2px; font-family:'Cormorant Garamond',serif; font-style:italic; }
  .header-stats { font-size:12px; color:var(--dim); letter-spacing:1px; text-align:right; }
  .header-stats strong { color:var(--gold2); font-weight:600; }

  /* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
  .toolbar {
    padding:14px 20px;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    border-bottom:1px solid var(--border);
    background:rgba(14,10,18,0.8);
  }
  .btn {
    padding:8px 16px; border-radius:6px; border:none; cursor:pointer;
    font-family:'Cinzel',serif; font-size:11px; letter-spacing:2px;
    transition:all 0.2s; white-space:nowrap;
  }
  .btn-primary  { background:var(--gold); color:#050308; }
  .btn-primary:hover  { background:var(--gold2); box-shadow:0 0 15px rgba(212,168,67,0.4); }
  .btn-ghost    { background:transparent; color:var(--gold); border:1px solid var(--border); }
  .btn-ghost:hover { border-color:var(--gold); background:rgba(212,168,67,0.07); }
  .btn-danger   { background:transparent; color:var(--red2); border:1px solid rgba(192,57,43,0.3); }
  .btn-danger:hover { background:rgba(192,57,43,0.12); border-color:var(--red2); }
  .btn-success  { background:var(--green); color:#fff; border:none; }
  .btn-success:hover { background:var(--green2); box-shadow:0 0 15px rgba(39,174,96,0.3); }

  .search-wrap { flex:1; min-width:180px; position:relative; }
  .search-wrap input {
    width:100%; padding:8px 14px 8px 36px;
    background:var(--input-bg); border:1px solid var(--border);
    border-radius:6px; color:var(--text);
    font-family:'Cormorant Garamond',serif; font-size:14px;
    outline:none; transition:border 0.2s;
  }
  .search-wrap input:focus { border-color:var(--gold); }
  .search-wrap input::placeholder { color:var(--dim); }
  .search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--dim); font-size:13px; pointer-events:none; }

  .filter-select {
    padding:8px 12px; background:var(--input-bg); border:1px solid var(--border);
    border-radius:6px; color:var(--text); font-size:13px; outline:none; cursor:pointer;
  }
  .filter-select:focus { border-color:var(--gold); }

  /* ‚îÄ‚îÄ OBJECT LIST ‚îÄ‚îÄ */
  .obj-list { padding:16px 20px; display:flex; flex-direction:column; gap:8px; }

  .obj-card {
    background:var(--panel); border:1px solid var(--border);
    border-radius:10px; padding:14px 16px;
    display:flex; align-items:flex-start; gap:14px;
    transition:border-color 0.2s, box-shadow 0.2s;
    cursor:pointer;
  }
  .obj-card:hover { border-color:rgba(212,168,67,0.3); box-shadow:0 2px 20px rgba(212,168,67,0.07); }
  .obj-card.expanded { border-color:rgba(212,168,67,0.4); box-shadow:0 4px 30px rgba(212,168,67,0.1); }

  .obj-emoji-badge {
    font-size:28px; width:44px; height:44px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(212,168,67,0.06); border-radius:8px; flex-shrink:0;
  }
  .obj-info { flex:1; min-width:0; }
  .obj-name  { font-family:'Cinzel',serif; font-size:13px; letter-spacing:2px; color:var(--gold2); }
  .obj-meta  { font-size:11px; color:var(--dim); letter-spacing:1px; margin-top:4px; }
  .obj-preview-snippet {
    font-size:12px; color:var(--dim); margin-top:6px;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    font-style:italic; max-width:100%;
  }

  .obj-actions { display:flex; gap:6px; flex-shrink:0; align-items:center; }
  .icon-btn {
    width:32px; height:32px; border-radius:6px; border:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    font-size:14px; transition:all 0.15s;
  }
  .icon-btn.edit-btn   { background:rgba(212,168,67,0.1); color:var(--gold); }
  .icon-btn.edit-btn:hover { background:rgba(212,168,67,0.2); }
  .icon-btn.delete-btn { background:rgba(192,57,43,0.1); color:var(--red2); }
  .icon-btn.delete-btn:hover { background:rgba(192,57,43,0.22); }


  /* ‚îÄ‚îÄ BULK SELECT ‚îÄ‚îÄ */
  .obj-card.selected { border-color:rgba(212,168,67,0.6); background:rgba(212,168,67,0.06); }
  .obj-checkbox {
    width:18px; height:18px; border-radius:4px; border:1.5px solid rgba(212,168,67,0.3);
    background:transparent; cursor:pointer; flex-shrink:0; appearance:none;
    display:flex; align-items:center; justify-content:center; transition:all 0.15s;
  }
  .obj-checkbox:checked { background:var(--gold); border-color:var(--gold); }
  .obj-checkbox:checked::after { content:"‚úì"; color:#050308; font-size:11px; font-weight:700; }
  .bulk-bar {
    display:none; align-items:center; gap:12px; padding:10px 20px;
    background:rgba(212,168,67,0.08); border-bottom:1px solid rgba(212,168,67,0.2);
    font-family:'Cinzel',serif; font-size:11px; letter-spacing:2px;
  }
  .bulk-bar.show { display:flex; }
  .bulk-count { color:var(--gold2); }
  .bulk-actions { display:flex; gap:8px; margin-left:auto; }

  /* Expand detail */
  .obj-detail {
    display:none; margin-top:12px; padding-top:12px;
    border-top:1px solid var(--border);
    flex-direction:column; gap:10px;
  }
  .obj-card.expanded .obj-detail { display:flex; }
  .detail-label { font-family:'Cinzel',serif; font-size:9px; letter-spacing:3px; color:var(--dim); margin-bottom:4px; }
  .detail-text  { font-size:13px; color:var(--text); line-height:1.7; white-space:pre-wrap; }
  .detail-section { background:rgba(0,0,0,0.2); border-radius:6px; padding:10px 12px; border-left:2px solid var(--border); }
  .detail-section.dark-section  { border-left-color:rgba(155,27,27,0.5); }
  .detail-section.advice-section { border-left-color:rgba(212,168,67,0.35); }

  /* empty state */
  .empty-state { text-align:center; padding:60px 20px; color:var(--dim); }
  .empty-state .big { font-size:40px; margin-bottom:14px; opacity:0.4; }
  .empty-state p { font-size:13px; letter-spacing:1px; font-style:italic; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position:fixed; inset:0; z-index:500;
    background:rgba(5,3,8,0.92); backdrop-filter:blur(8px);
    display:none; align-items:flex-start; justify-content:center;
    overflow-y:auto; padding:30px 16px;
  }
  .modal-overlay.open { display:flex; }

  .modal {
    background:var(--panel); border:1px solid rgba(212,168,67,0.25);
    border-radius:14px; width:100%; max-width:560px;
    padding:28px; position:relative;
    box-shadow:0 20px 60px rgba(0,0,0,0.7);
    animation:modal-in 0.25s ease;
  }
  @keyframes modal-in { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }

  .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; }
  .modal-title  { font-family:'Cinzel',serif; font-size:14px; letter-spacing:4px; color:var(--gold); }
  .modal-close  {
    width:32px; height:32px; border-radius:50%; border:1px solid var(--border);
    background:transparent; color:var(--dim); cursor:pointer; font-size:16px;
    display:flex; align-items:center; justify-content:center; transition:all 0.15s;
  }
  .modal-close:hover { border-color:var(--gold); color:var(--gold); }

  .form-group    { margin-bottom:18px; }
  .form-label    { font-family:'Cinzel',serif; font-size:10px; letter-spacing:3px; color:var(--dim); display:block; margin-bottom:7px; }
  .form-label span { color:var(--red2); }

  .form-row { display:grid; grid-template-columns:80px 1fr; gap:12px; }

  .form-input, .form-textarea {
    width:100%; padding:10px 14px;
    background:var(--input-bg); border:1px solid var(--border);
    border-radius:7px; color:var(--text);
    font-family:'Cormorant Garamond',serif; font-size:14px;
    outline:none; transition:border 0.2s; resize:vertical;
  }
  .form-input:focus, .form-textarea:focus { border-color:var(--gold); }
  .form-input::placeholder, .form-textarea::placeholder { color:var(--dim); }
  .form-textarea { min-height:90px; line-height:1.6; }
  .form-textarea.tall { min-height:120px; }

  .emoji-preview { font-size:32px; display:flex; align-items:center; justify-content:center; background:var(--input-bg); border:1px solid var(--border); border-radius:7px; }

  .form-select {
    width:100%; padding:10px 14px;
    background:var(--input-bg); border:1px solid var(--border);
    border-radius:7px; color:var(--text); font-size:14px; outline:none; cursor:pointer;
  }
  .form-select:focus { border-color:var(--gold); }

  .modal-footer { display:flex; gap:10px; justify-content:flex-end; margin-top:24px; padding-top:18px; border-top:1px solid var(--border); }

  /* ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ */
  .confirm-msg { font-size:14px; line-height:1.7; color:var(--text); margin-bottom:8px; }
  .confirm-name { font-family:'Cinzel',serif; font-size:15px; color:var(--gold2); text-align:center; margin:16px 0; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast-container { position:fixed; bottom:24px; right:24px; z-index:9999; display:flex; flex-direction:column; gap:8px; }
  .toast {
    padding:12px 18px; border-radius:8px; font-size:13px; letter-spacing:1px;
    border:1px solid; animation:toast-in 0.3s ease; min-width:200px;
  }
  @keyframes toast-in { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
  .toast.success { background:#0d2b1a; border-color:rgba(39,174,96,0.4); color:#5dbc88; }
  .toast.error   { background:#2b0d0d; border-color:rgba(192,57,43,0.4); color:#e07070; }
  .toast.info    { background:#1a1408; border-color:rgba(212,168,67,0.3); color:var(--gold); }

  /* ‚îÄ‚îÄ IMPORT MODAL ‚îÄ‚îÄ */
  .import-area {
    width:100%; min-height:140px; padding:12px;
    background:var(--input-bg); border:1px solid var(--border);
    border-radius:7px; color:var(--text);
    font-family:monospace; font-size:12px;
    outline:none; resize:vertical;
  }
  .import-area:focus { border-color:var(--gold); }
  .import-hint { font-size:11px; color:var(--dim); font-style:italic; margin-top:6px; line-height:1.6; }

  /* ‚îÄ‚îÄ PIN CHANGE ‚îÄ‚îÄ */
  .pin-input-row { display:flex; gap:8px; }
  .pin-field {
    flex:1; padding:10px; text-align:center; letter-spacing:4px;
    background:var(--input-bg); border:1px solid var(--border);
    border-radius:7px; color:var(--gold2); font-size:18px;
    outline:none; font-family:'Cinzel',serif;
  }
  .pin-field:focus { border-color:var(--gold); }

  /* ‚îÄ‚îÄ CATEGORY BADGE ‚îÄ‚îÄ */
  .cat-badge {
    display:inline-block; padding:2px 8px; border-radius:4px; font-size:10px;
    letter-spacing:1px; font-family:'Cinzel',serif;
    background:rgba(212,168,67,0.1); color:var(--gold); border:1px solid rgba(212,168,67,0.2);
    margin-right:6px;
  }

  /* ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ */
  .pagination { display:flex; gap:8px; align-items:center; justify-content:center; padding:20px; }
  .page-btn { padding:6px 14px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--dim); cursor:pointer; font-size:12px; transition:all 0.2s; }
  .page-btn:hover { border-color:var(--gold); color:var(--gold); }
  .page-btn.active { background:var(--gold); color:#050308; border-color:var(--gold); font-weight:700; }
  .page-btn:disabled { opacity:0.3; cursor:default; }
  .page-info { font-size:12px; color:var(--dim); letter-spacing:1px; }

  /* ‚îÄ‚îÄ CATEGORY MANAGER ‚îÄ‚îÄ */
  .cat-list { display:flex; flex-direction:column; gap:8px; max-height:340px; overflow-y:auto; margin-bottom:16px; }
  .cat-row {
    display:flex; align-items:center; gap:10px;
    padding:10px 14px; background:rgba(0,0,0,0.25);
    border:1px solid var(--border); border-radius:8px;
    transition:border-color 0.2s;
  }
  .cat-row:hover { border-color:rgba(212,168,67,0.3); }
  .cat-name  { flex:1; font-family:'Cinzel',serif; font-size:12px; letter-spacing:2px; color:var(--gold2); }
  .cat-count { font-size:11px; color:var(--dim); min-width:60px; text-align:right; }
  .cat-actions { display:flex; gap:6px; }

  .cat-add-row { display:flex; gap:8px; margin-top:4px; }
  .cat-add-row input { flex:1; }

  /* rename inline */
  .cat-rename-input {
    flex:1; background:var(--input-bg); border:1px solid var(--gold);
    border-radius:5px; color:var(--gold2); padding:4px 10px;
    font-family:'Cinzel',serif; font-size:12px; letter-spacing:2px; outline:none;
  }

  /* ‚îÄ‚îÄ MOVE OBJECTS MODAL ‚îÄ‚îÄ */
  .move-info { font-size:13px; color:var(--text); line-height:1.7; margin-bottom:16px; }
  .move-info strong { color:var(--gold2); }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width:500px) {
    .toolbar { flex-direction:column; align-items:stretch; }
    .search-wrap { width:100%; }
    .form-row { grid-template-columns:60px 1fr; }
    .modal { padding:20px; }
  }

  /* ‚îÄ‚îÄ BACK NAV ‚îÄ‚îÄ */
  .back-nav {
    position: fixed;
    top: 12px; left: 12px;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .back-btn {
    display: flex; align-items: center; gap: 7px;
    padding: 7px 14px 7px 10px;
    background: rgba(8,5,7,0.85);
    border: 1px solid rgba(212,168,67,0.2);
    border-radius: 20px;
    color: #D4A843;
    font-family: 'Cinzel', serif;
    font-size: 10px; letter-spacing: 2px;
    text-decoration: none;
    backdrop-filter: blur(8px);
    transition: all 0.2s;
    cursor: pointer;
  }
  .back-btn:hover {
    background: rgba(212,168,67,0.12);
    border-color: rgba(212,168,67,0.45);
    box-shadow: 0 0 14px rgba(212,168,67,0.15);
  }
  .back-btn .arrow { font-size: 13px; line-height: 1; }
  .back-btn .label { line-height: 1; }

</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOCK SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lockScreen">
  <div class="lock-symbol">üîê</div>
  <div class="lock-title">MASTER LIBRARY</div>
  <div class="lock-sub">akses terbatas ¬∑ admin only</div>
  <div class="pin-dots" style="display:flex;gap:12px;justify-content:center;margin:16px 0;">
    <input id="adminPassInput" type="password" placeholder="Password Admin"
      style="padding:10px 16px;background:#0a0710;border:1px solid rgba(212,168,67,0.2);border-radius:8px;color:#e8ddd0;font-size:15px;outline:none;width:220px;text-align:center;letter-spacing:2px;font-family:'Cinzel',serif;"
      onkeydown="if(event.key==='Enter')checkAdminPassEdit()">
  </div>
  <button onclick="checkAdminPassEdit()" style="padding:10px 28px;background:#D4A843;color:#050308;border:none;border-radius:8px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;cursor:pointer;">MASUK</button>
  <div class="lock-error" id="lockError">Password salah.</div>
  <div class="lock-hint">Gunakan password admin yang sama dengan admin.html</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appScreen">

<div class="back-nav" id="backNav" style="display:none;">
  <a class="back-btn" id="backBtn" href="#">
    <span class="arrow">‚Äπ</span>
    <span class="label">DASHBOARD</span>
  </a>
</div>
<script>
  (function() {
    var uid = "admin";
    if (uid) {
      var nav = document.getElementById("backNav");
      var btn = document.getElementById("backBtn");
      if (nav && btn) {
        nav.style.display = "flex";
        btn.href = "admin.html";
      }
    }
  })();
</script>


  <!-- Header -->
  <div class="app-header">
    <div class="header-brand">
      OBJECTIF.ID
      <span>‚ú¶ &nbsp; Editor Objek</span>
    </div>
    <div class="header-stats" id="headerStats">
      Memuat<span id="totalCount"></span>...
    </div>
  </div>

  <!-- Update Banner -->
  <div id="updateBanner" style="display:none;background:rgba(212,168,67,0.08);border-bottom:1px solid rgba(212,168,67,0.2);padding:12px 20px;display:none;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div>
      <span style="font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;color:var(--gold);">üìö &nbsp;UPDATE TERSEDIA</span>
      <span id="updateBannerMsg" style="font-size:12px;color:var(--dim);font-style:italic;margin-left:12px;"></span>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" style="font-size:9px;padding:6px 14px;" onclick="doSyncMaster()">‚ü≥ &nbsp;Sync Sekarang</button>
      <button class="btn btn-ghost"   style="font-size:9px;padding:6px 14px;" onclick="dismissUpdateBanner()">Nanti</button>
    </div>
  </div>

  <!-- Bulk Bar -->
  <div class="bulk-bar" id="bulkBar">
    <input type="checkbox" class="obj-checkbox" id="selectAllCheck" onchange="toggleSelectAll(this.checked)" title="Pilih Semua">
    <span class="bulk-count" id="bulkCount">0 dipilih</span>
    <div class="bulk-actions">
      <button class="btn btn-danger" style="font-size:9px;padding:6px 14px;" onclick="bulkDelete()">üóë Hapus Terpilih</button>
      <button class="btn btn-ghost"  style="font-size:9px;padding:6px 14px;" onclick="clearSelection()">‚úï Batal</button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn btn-primary" onclick="openAddModal()">Ôºã &nbsp;Tambah Objek</button>
    <button class="btn btn-ghost"   onclick="toggleBulkMode()" id="bulkModeBtn">‚òë Pilih</button>
    <button class="btn btn-ghost"   onclick="openImportModal()">‚¨Ü Import</button>
    <button class="btn btn-ghost"   onclick="exportAll()">‚¨á Export</button>
    <button class="btn btn-ghost"   onclick="openCatModal()">üóÇ Kategori</button>

    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Cari nama atau isi..." oninput="onSearch()">
    </div>

    <select class="filter-select" id="categoryFilter" onchange="onFilter()">
      <option value="">Semua Kategori</option>
    </select>
  </div>

  <!-- List -->
  <div class="obj-list" id="objList"></div>

  <!-- Pagination -->
  <div class="pagination" id="pagination"></div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: ADD/EDIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="editModalTitle">TAMBAH OBJEK</div>
      <button class="modal-close" onclick="closeModal('editModal')">‚úï</button>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">EMOJI <span>*</span></label>
        <div class="emoji-preview" id="emojiPreview" style="height:46px;font-size:28px;">‚ùì</div>
      </div>
      <div class="form-group">
        <label class="form-label">EMOJI (ketik/paste) <span>*</span></label>
        <input class="form-input" id="fEmoji" placeholder="üîÆ" oninput="document.getElementById('emojiPreview').textContent=this.value||'‚ùì'">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">NAMA OBJEK <span>*</span></label>
      <input class="form-input" id="fName" placeholder="Contoh: Baterai Remote">
    </div>

    <div class="form-group">
      <label class="form-label">KATEGORI</label>
      <select class="form-select" id="fCategory">
        <option value="tambahan">tambahan</option>
        <option value="sehari-hari">sehari-hari</option>
        <option value="makanan">makanan</option>
        <option value="teknologi">teknologi</option>
        <option value="alam">alam</option>
        <option value="sosial">sosial</option>
        <option value="perkakas">perkakas</option>
        <option value="kosmetik">kosmetik</option>
        <option value="sarkas-ringan">sarkas-ringan</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">PREVIEW <span>*</span> <span style="color:var(--dim);font-family:serif;font-style:italic;letter-spacing:0;font-size:10px;">‚Äî teks yang dibacakan gratis</span></label>
      <textarea class="form-textarea tall" id="fPreview" placeholder="Kamu itu baterai remote..."></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">SISI GELAP / DALAM <span>*</span> <span style="color:var(--dim);font-family:serif;font-style:italic;letter-spacing:0;font-size:10px;">‚Äî butuh gift</span></label>
      <textarea class="form-textarea" id="fDark" placeholder="Kamu habis pelan-pelan..."></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">SARAN / PESAN <span>*</span> <span style="color:var(--dim);font-family:serif;font-style:italic;letter-spacing:0;font-size:10px;">‚Äî butuh gift</span></label>
      <textarea class="form-textarea" id="fAdvice" placeholder="Energi itu bukan untuk semua orang..."></textarea>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('editModal')">Batal</button>
      <button class="btn btn-success" onclick="saveObject()">üíæ &nbsp;Simpan</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: CATEGORY MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="catModal">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <div class="modal-title">üóÇ MANAJEMEN KATEGORI</div>
      <button class="modal-close" onclick="closeModal('catModal')">‚úï</button>
    </div>

    <div class="cat-list" id="catList"></div>

    <!-- Add new category -->
    <div style="border-top:1px solid var(--border); padding-top:14px;">
      <div class="form-label" style="margin-bottom:8px;">TAMBAH KATEGORI BARU</div>
      <div class="cat-add-row">
        <input class="form-input" id="newCatInput" placeholder="nama-kategori" onkeydown="if(event.key==='Enter')addCategory()">
        <button class="btn btn-primary" onclick="addCategory()">Ôºã Tambah</button>
      </div>
      <div style="font-size:11px;color:var(--dim);font-style:italic;margin-top:6px;">Gunakan huruf kecil dan tanda hubung. Contoh: sarkas-ringan</div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('catModal')">Tutup</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: MOVE OBJECTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="moveModal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">HAPUS KATEGORI</div>
      <button class="modal-close" onclick="closeModal('moveModal')">‚úï</button>
    </div>
    <div class="move-info" id="moveInfo"></div>
    <div class="form-group">
      <label class="form-label">PINDAHKAN OBJEK KE KATEGORI</label>
      <select class="form-select" id="moveTarget"></select>
    </div>
    <div style="font-size:11px;color:rgba(192,57,43,0.8);font-style:italic;margin-top:-8px;margin-bottom:4px;" id="moveDeleteNote"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost"  onclick="closeModal('moveModal')">Batal</button>
      <button class="btn btn-danger" onclick="confirmDeleteCat()">üóë Hapus Kategori</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: CONFIRM DELETE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title">HAPUS OBJEK</div>
      <button class="modal-close" onclick="closeModal('confirmModal')">‚úï</button>
    </div>
    <p class="confirm-msg">Yakin ingin menghapus objek ini? Tindakan tidak bisa dibatalkan.</p>
    <div class="confirm-name" id="confirmName"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost"  onclick="closeModal('confirmModal')">Batal</button>
      <button class="btn btn-danger" onclick="confirmDelete()">üóë &nbsp;Hapus</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: SYNC MASTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="syncModal">
  <div class="modal" style="max-width:460px;">
    <div class="modal-header">
      <div class="modal-title">‚ü≥ SYNC MASTER LIBRARY</div>
      <button class="modal-close" onclick="closeModal('syncModal')">‚úï</button>
    </div>
    <div id="syncInfo" style="margin-bottom:18px;">
      <div style="font-size:13px;color:var(--dim);font-style:italic;line-height:1.8;">Memuat info master library...</div>
    </div>
    <div style="background:rgba(192,57,43,0.08);border:1px solid rgba(192,57,43,0.2);border-radius:8px;padding:12px 16px;margin-bottom:18px;">
      <div style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;color:var(--red2);margin-bottom:6px;">‚ö† PERHATIAN</div>
      <div style="font-size:12px;color:var(--text);line-height:1.7;">Mode <strong>Ganti Semua</strong> akan menghapus seluruh objek kamu dan diganti dengan master library. Mode <strong>Tambahkan</strong> hanya menambah objek yang belum ada (cek berdasarkan nama).</div>
    </div>
    <div class="form-group">
      <label class="form-label">MODE SYNC</label>
      <select class="form-select" id="syncMode">
        <option value="replace">Ganti Semua (replace)</option>
        <option value="merge">Tambahkan Saja (merge)</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost"   onclick="closeModal('syncModal')">Batal</button>
      <button class="btn btn-success" onclick="confirmSync()">‚ü≥ &nbsp;Sync Sekarang</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="importModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">IMPORT OBJEK</div>
      <button class="modal-close" onclick="closeModal('importModal')">‚úï</button>
    </div>
    <div class="form-group">
      <label class="form-label">PASTE JSON ARRAY</label>
      <textarea class="import-area" id="importText" placeholder='[
  {
    "emoji": "üîÆ",
    "name": "Nama Objek",
    "category": "tambahan",
    "preview": "Teks preview...",
    "full_dark": "Sisi gelap...",
    "full_advice": "Saran..."
  }
]'></textarea>
      <p class="import-hint">Paste array JSON. Objek yang sudah ada tidak akan ditimpa ‚Äî hanya menambah yang baru. Kamu juga bisa export dulu untuk melihat format yang benar.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('importModal')">Batal</button>
      <button class="btn btn-success" onclick="doImport()">‚¨Ü &nbsp;Import Sekarang</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: GANTI PIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="pinModal">
  <div class="modal" style="max-width:380px;">
    <div class="modal-header">
      <div class="modal-title">GANTI PIN</div>
      <button class="modal-close" onclick="closeModal('pinModal')">‚úï</button>
    </div>
    <div class="form-group">
      <label class="form-label">PIN LAMA</label>
      <input class="form-input" id="pinOld" type="password" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
    </div>
    <div class="form-group">
      <label class="form-label">PIN BARU (4 digit)</label>
      <input class="form-input" id="pinNew" type="password" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
    </div>
    <div class="form-group">
      <label class="form-label">KONFIRMASI PIN BARU</label>
      <input class="form-input" id="pinConfirm" type="password" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('pinModal')">Batal</button>
      <button class="btn btn-success" onclick="doChangePin()">‚úì &nbsp;Simpan PIN</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST CONTAINER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="toast-container" id="toastContainer"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE + LOGIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp }           from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, get, push, remove, onValue, update }
                                    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCa7Gx76AA9GE0bPdCApDMMysrxYdb4gzc",
  authDomain: "wujud-asli.firebaseapp.com",
  databaseURL: "https://wujud-asli-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "wujud-asli",
  storageBucket: "wujud-asli.firebasestorage.app",
  messagingSenderId: "925029041014",
  appId: "1:925029041014:web:ccae53254a649cdb0ab057"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// ‚îÄ‚îÄ ADMIN MODE: BASE = master ‚îÄ‚îÄ
const BASE = "master";

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let allObjects   = [];  // [{id, emoji, name, category, preview, full_dark, full_advice}]
let filtered     = [];
let currentPage  = 1;
const PER_PAGE   = 20;
let editingId    = null;
let deletingId   = null;
let currentPin   = "1234";

// ‚îÄ‚îÄ ADMIN PASSWORD LOGIN ‚îÄ‚îÄ
window.checkAdminPassEdit = async () => {
  const input = document.getElementById("adminPassInput").value;
  const snap  = await get(ref(db, "config/adminPassword"));
  const stored = snap.val() || "admin123";
  if (input === stored) {
    document.getElementById("lockScreen").style.display = "none";
    document.getElementById("appScreen").style.display  = "block";
    loadObjects();
    loadExtraCategories();
  } else {
    const err = document.getElementById("lockError");
    err.classList.add("show");
    document.getElementById("adminPassInput").value = "";
    setTimeout(() => err.classList.remove("show"), 2000);
  }
};

// ‚îÄ‚îÄ LOAD OBJECTS FROM FIREBASE ‚îÄ‚îÄ
function loadObjects() {
  onValue(ref(db, `${BASE}/objects`), snap => {
    const data = snap.val() || {};
    allObjects = Object.entries(data).map(([id, obj]) => ({id, ...obj}));
    // Sort by name
    allObjects.sort((a,b) => a.name.localeCompare(b.name));
    buildCategoryFilter();
    syncCategoryDropdown();
    applyFilter();
    updateStats();
  });
}

function updateStats() {
  const cats = [...new Set(allObjects.map(o=>o.category))].length;
  document.getElementById("headerStats").innerHTML =
    `<strong>${allObjects.length}</strong> objek &nbsp;¬∑&nbsp; <strong>${cats}</strong> kategori`;
}

// ‚îÄ‚îÄ CATEGORY FILTER ‚îÄ‚îÄ
function buildCategoryFilter() {
  const cats = [...new Set(allObjects.map(o=>o.category))].sort();
  const sel  = document.getElementById("categoryFilter");
  const cur  = sel.value;
  sel.innerHTML = `<option value="">Semua Kategori (${allObjects.length})</option>`;
  cats.forEach(c => {
    const count = allObjects.filter(o=>o.category===c).length;
    const opt   = document.createElement("option");
    opt.value   = c; opt.textContent = `${c} (${count})`;
    if (c===cur) opt.selected = true;
    sel.appendChild(opt);
  });
}

// ‚îÄ‚îÄ FILTER + SEARCH ‚îÄ‚îÄ
window.onSearch = window.onFilter = () => { currentPage=1; applyFilter(); };

function applyFilter() {
  const q   = document.getElementById("searchInput").value.toLowerCase().trim();
  const cat = document.getElementById("categoryFilter").value;
  filtered  = allObjects.filter(o => {
    const matchCat = !cat || o.category === cat;
    const matchQ   = !q || [o.name,o.preview,o.full_dark,o.full_advice].join(" ").toLowerCase().includes(q);
    return matchCat && matchQ;
  });
  renderList();
  renderPagination();
}

// ‚îÄ‚îÄ RENDER LIST ‚îÄ‚îÄ
function renderList() {
  const list  = document.getElementById("objList");
  const start = (currentPage-1)*PER_PAGE;
  const page  = filtered.slice(start, start+PER_PAGE);

  if (!page.length) {
    list.innerHTML = `<div class="empty-state"><div class="big">üîÆ</div><p>Tidak ada objek ditemukan</p></div>`;
    return;
  }

  list.innerHTML = page.map(obj => `
    <div class="obj-card ${selectedIds.has(obj.id)?'selected':''}" id="card-${obj.id}" onclick="handleCardClick(event,'${obj.id}')">
      <input type="checkbox" class="obj-checkbox" id="chk-${obj.id}"
        style="display:var(--chk-display,none);margin-top:2px;"
        onclick="event.stopPropagation()" onchange="onCheckChange('${obj.id}',this.checked)">
      <div class="obj-emoji-badge">${obj.emoji}</div>
      <div class="obj-info">
        <div class="obj-name">${escHtml(obj.name)}</div>
        <div class="obj-meta">
          <span class="cat-badge">${obj.category||"‚Äî"}</span>
        </div>
        <div class="obj-preview-snippet">${escHtml((obj.preview||"").split("\n")[0])}</div>

        <div class="obj-detail">
          <div class="detail-section">
            <div class="detail-label">PREVIEW</div>
            <div class="detail-text">${escHtml(obj.preview||"")}</div>
          </div>
          <div class="detail-section dark-section">
            <div class="detail-label">SISI GELAP / DALAM</div>
            <div class="detail-text">${escHtml(obj.full_dark||"")}</div>
          </div>
          <div class="detail-section advice-section">
            <div class="detail-label">SARAN / PESAN</div>
            <div class="detail-text">${escHtml(obj.full_advice||"")}</div>
          </div>
        </div>
      </div>
      <div class="obj-actions" onclick="event.stopPropagation()">
        <button class="icon-btn edit-btn"   onclick="openEditModal('${obj.id}')" title="Edit">‚úèÔ∏è</button>
        <button class="icon-btn delete-btn" onclick="openDeleteModal('${obj.id}')" title="Hapus">üóë</button>
      </div>
    </div>
  `).join("");
}

window.toggleCard = (id) => {
  const card = document.getElementById("card-"+id);
  if (card) card.classList.toggle("expanded");
};

// ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ
function renderPagination() {
  const total = Math.ceil(filtered.length / PER_PAGE);
  const pg    = document.getElementById("pagination");
  if (total <= 1) { pg.innerHTML=""; return; }

  let html = `<button class="page-btn" onclick="goPage(${currentPage-1})" ${currentPage===1?"disabled":""}>‚Äπ Prev</button>`;
  for (let i=1;i<=total;i++) {
    if (i===1||i===total||Math.abs(i-currentPage)<=2) {
      html += `<button class="page-btn ${i===currentPage?"active":""}" onclick="goPage(${i})">${i}</button>`;
    } else if (Math.abs(i-currentPage)===3) {
      html += `<span class="page-info">‚Ä¶</span>`;
    }
  }
  html += `<button class="page-btn" onclick="goPage(${currentPage+1})" ${currentPage===total?"disabled":""}>Next ‚Ä∫</button>`;
  html += `<span class="page-info">${filtered.length} objek</span>`;
  pg.innerHTML = html;
}

window.goPage = (p) => {
  const total = Math.ceil(filtered.length/PER_PAGE);
  if (p<1||p>total) return;
  currentPage = p;
  renderList();
  renderPagination();
  window.scrollTo({top:0,behavior:"smooth"});
};

// ‚îÄ‚îÄ ADD/EDIT MODAL ‚îÄ‚îÄ
window.openAddModal = () => {
  editingId = null;
  document.getElementById("editModalTitle").textContent = "TAMBAH OBJEK";
  ["fEmoji","fName","fPreview","fDark","fAdvice"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("fCategory").value = "tambahan";
  document.getElementById("emojiPreview").textContent = "‚ùì";
  openModal("editModal");
};

window.openEditModal = (id) => {
  const obj = allObjects.find(o=>o.id===id);
  if (!obj) return;
  editingId = id;
  document.getElementById("editModalTitle").textContent = "EDIT OBJEK";
  document.getElementById("fEmoji").value    = obj.emoji||"";
  document.getElementById("fName").value     = obj.name||"";
  document.getElementById("fCategory").value = obj.category||"tambahan";
  document.getElementById("fPreview").value  = obj.preview||"";
  document.getElementById("fDark").value     = obj.full_dark||"";
  document.getElementById("fAdvice").value   = obj.full_advice||"";
  document.getElementById("emojiPreview").textContent = obj.emoji||"‚ùì";
  openModal("editModal");
};

window.saveObject = async () => {
  const emoji   = document.getElementById("fEmoji").value.trim();
  const name    = document.getElementById("fName").value.trim();
  const cat     = document.getElementById("fCategory").value;
  const preview = document.getElementById("fPreview").value.trim();
  const dark    = document.getElementById("fDark").value.trim();
  const advice  = document.getElementById("fAdvice").value.trim();

  if (!emoji||!name||!preview||!dark||!advice) {
    toast("Semua field wajib diisi!", "error"); return;
  }

  const data = { emoji, name, category:cat, preview, full_dark:dark, full_advice:advice };

  try {
    if (editingId) {
      await update(ref(db, `${BASE}/objects/${editingId}`), data);
      toast(`‚úÖ ${name} berhasil diupdate`, "success");
    await set(ref(db, "master/lastUpdated"), Date.now());
    } else {
      await push(ref(db, `${BASE}/objects`), data);
      await set(ref(db, "master/lastUpdated"), Date.now());
      toast(`‚úÖ ${name} berhasil ditambahkan`, "success");
    }
    closeModal("editModal");
  } catch(e) {
    toast("Gagal menyimpan: "+e.message, "error");
  }
};

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
window.openDeleteModal = (id) => {
  const obj = allObjects.find(o=>o.id===id);
  if (!obj) return;
  deletingId = id;
  document.getElementById("confirmName").textContent = obj.emoji+" "+obj.name;
  openModal("confirmModal");
};

window.confirmDelete = async () => {
  if (!deletingId) return;
  const obj = allObjects.find(o=>o.id===deletingId);
  try {
    await remove(ref(db, `${BASE}/objects/${deletingId}`));
    await set(ref(db, "master/lastUpdated"), Date.now());
    toast(`üóë ${obj?.name||"Objek"} dihapus`, "info");
    closeModal("confirmModal");
  } catch(e) {
    toast("Gagal hapus: "+e.message, "error");
  }
  deletingId = null;
};

// ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ
window.openImportModal = () => {
  document.getElementById("importText").value = "";
  openModal("importModal");
};

window.doImport = async () => {
  const raw = document.getElementById("importText").value.trim();
  let arr;
  try { arr = JSON.parse(raw); } catch(e) { toast("Format JSON tidak valid!", "error"); return; }
  if (!Array.isArray(arr)) { toast("Harus berupa array []", "error"); return; }

  let count = 0;
  for (const obj of arr) {
    if (!obj.name||!obj.emoji) continue;
    await push(ref(db, `${BASE}/objects`), {
      emoji:      obj.emoji||"‚ùì",
      name:       obj.name||"",
      category:   obj.category||"tambahan",
      preview:    obj.preview||"",
      full_dark:  obj.full_dark||"",
      full_advice:obj.full_advice||""
    });
    count++;
  }
  toast(`‚úÖ ${count} objek berhasil diimport`, "success");
  closeModal("importModal");
};

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
window.exportAll = () => {
  const data = allObjects.map(({id,...rest})=>rest);
  const blob  = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url   = URL.createObjectURL(blob);
  const a     = document.createElement("a");
  a.href      = url;
  a.download  = "objectif-objects.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("‚¨á Export berhasil", "info");
};

// ‚îÄ‚îÄ CATEGORY MANAGER ‚îÄ‚îÄ
let deletingCat  = null;
let renamingCat  = null;

window.openCatModal = () => {
  renderCatList();
  openModal("catModal");
};

function getCategories() {
  const cats = {};
  allObjects.forEach(o => {
    const c = o.category || "tambahan";
    cats[c] = (cats[c] || 0) + 1;
  });
  return cats;
}

async function renderCatList() {
  const fromObjs = getCategories(); // {cat: count}
  const snap     = await get(ref(db, `${BASE}/config/categories`));
  const configCats = snap.val() || [];

  // Gabung semua: dari objek + dari config (termasuk yang kosong)
  const allCats = [...new Set([...Object.keys(fromObjs), ...configCats])].sort();
  const list    = document.getElementById("catList");

  if (!allCats.length) {
    list.innerHTML = `<div style="text-align:center;color:var(--dim);padding:20px;font-style:italic;">Belum ada kategori</div>`;
    return;
  }

  list.innerHTML = allCats.map(cat => {
    const count = fromObjs[cat] || 0;
    return `
      <div class="cat-row" id="catrow-${cat}">
        <div class="cat-name" id="catname-${cat}">${cat}</div>
        <div class="cat-count" style="color:${count===0?'rgba(192,57,43,0.6)':'var(--dim)'}">
          ${count === 0 ? "kosong" : count+" objek"}
        </div>
        <div class="cat-actions">
          <button class="icon-btn edit-btn"   onclick="startRename('${cat}')" title="Rename">‚úèÔ∏è</button>
          <button class="icon-btn delete-btn" onclick="openDeleteCat('${cat}', ${count})" title="Hapus">üóë</button>
        </div>
      </div>
    `;
  }).join("");
}

window.startRename = (cat) => {
  // Restore any previous rename
  if (renamingCat && renamingCat !== cat) cancelRename(renamingCat);
  renamingCat = cat;

  const nameEl = document.getElementById("catname-"+cat);
  nameEl.innerHTML = `
    <input class="cat-rename-input" id="renameinput-${cat}"
      value="${cat}"
      onkeydown="if(event.key==='Enter')doRename('${cat}'); if(event.key==='Escape')cancelRename('${cat}')">
    <button class="icon-btn edit-btn" onclick="doRename('${cat}')" style="width:28px;height:28px;margin-left:6px;" title="Simpan">‚úì</button>
    <button class="icon-btn" onclick="cancelRename('${cat}')" style="width:28px;height:28px;background:rgba(122,106,85,0.15);color:var(--dim);" title="Batal">‚úï</button>
  `;
  setTimeout(() => document.getElementById("renameinput-"+cat)?.focus(), 50);
};

window.cancelRename = (cat) => {
  renamingCat = null;
  const nameEl = document.getElementById("catname-"+cat);
  if (nameEl) nameEl.innerHTML = cat;
};

window.doRename = async (oldCat) => {
  const input   = document.getElementById("renameinput-"+oldCat);
  if (!input) return;
  const newCat  = input.value.trim().toLowerCase().replace(/\s+/g,"-");

  if (!newCat)           { toast("Nama kategori tidak boleh kosong!", "error"); return; }
  if (newCat === oldCat) { cancelRename(oldCat); return; }

  const cats = getCategories();
  if (cats[newCat] !== undefined) { toast(`Kategori "${newCat}" sudah ada!`, "error"); return; }

  // Update semua objek yang pakai kategori lama
  const targets = allObjects.filter(o => o.category === oldCat);
  toast(`Mengupdate ${targets.length} objek...`, "info");

  try {
    for (const obj of targets) {
      await update(ref(db, `${BASE}/objects/${obj.id}`), { category: newCat });
    }
    // Update dropdown form juga
    updateCategoryDropdown(oldCat, newCat);
    renamingCat = null;
    toast(`‚úÖ Kategori "${oldCat}" ‚Üí "${newCat}" (${targets.length} objek diupdate)`, "success");
    renderCatList();
  } catch(e) {
    toast("Gagal rename: "+e.message, "error");
  }
};

window.addCategory = async () => {
  const input = document.getElementById("newCatInput");
  const name  = input.value.trim().toLowerCase().replace(/\s+/g,"-");
  if (!name) { toast("Nama kategori tidak boleh kosong!", "error"); return; }

  // Cek duplikat dari objek + config
  const snap     = await get(ref(db, `${BASE}/config/categories`));
  const existing = snap.val() || [];
  const fromObjs = [...new Set(allObjects.map(o => o.category).filter(Boolean))];
  const allCats  = [...new Set([...existing, ...fromObjs])];
  if (allCats.includes(name)) { toast(`Kategori "${name}" sudah ada!`, "error"); return; }

  // Simpan ke Firebase config
  await set(ref(db, `${BASE}/config/categories`), [...existing, name]);

  // Tambah ke dropdown form
  addCategoryOption(name);
  input.value = "";
  toast(`‚úÖ Kategori "${name}" ditambahkan`, "success");
  renderCatList();
};

window.openDeleteCat = (cat, count) => {
  deletingCat = cat;
  const cats    = getCategories();
  const others  = Object.keys(cats).filter(c => c !== cat);

  document.getElementById("moveInfo").innerHTML =
    `Kategori <strong>${cat}</strong> memiliki <strong>${count} objek</strong>.<br>
     Pilih tujuan pemindahan sebelum menghapus kategori ini.`;

  const sel = document.getElementById("moveTarget");
  sel.innerHTML = others.map(c => `<option value="${c}">${c} (${cats[c]} objek)</option>`).join("");

  if (!others.length) {
    sel.innerHTML = `<option value="tambahan">tambahan</option>`;
    document.getElementById("moveDeleteNote").textContent =
      "Tidak ada kategori lain. Objek akan dipindah ke \"tambahan\".";
  } else {
    document.getElementById("moveDeleteNote").textContent = "";
  }

  openModal("moveModal");
};

window.confirmDeleteCat = async () => {
  if (!deletingCat) return;
  const targetCat = document.getElementById("moveTarget").value || "tambahan";
  const targets   = allObjects.filter(o => o.category === deletingCat);

  if (targets.length > 0) {
    toast(`Memindahkan ${targets.length} objek ke "${targetCat}"...`, "info");
    try {
      for (const obj of targets) {
        await update(ref(db, `${BASE}/objects/${obj.id}`), { category: targetCat });
      }
    } catch(e) {
      toast("Gagal memindahkan objek: "+e.message, "error"); return;
    }
  }

  // Hapus dari config/categories
  const snap = await get(ref(db, `${BASE}/config/categories`));
  const cats  = (snap.val() || []).filter(c => c !== deletingCat);
  await set(ref(db, `${BASE}/config/categories`), cats);

  // Hapus dari dropdown form
  const sel = document.getElementById("fCategory");
  Array.from(sel.options).forEach(opt => { if (opt.value === deletingCat) opt.remove(); });

  toast(`‚úÖ Kategori "${deletingCat}" dihapus${targets.length>0?`. ${targets.length} objek dipindah ke "${targetCat}"`:""}`, "success");
  deletingCat = null;
  closeModal("moveModal");
  renderCatList();
  buildCategoryFilter();
};

function updateCategoryDropdown(oldCat, newCat) {
  const sel = document.getElementById("fCategory");
  Array.from(sel.options).forEach(opt => {
    if (opt.value === oldCat) { opt.value = newCat; opt.textContent = newCat; }
  });
}

function addCategoryOption(name) {
  const sel = document.getElementById("fCategory");
  if (!Array.from(sel.options).find(o => o.value === name)) {
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = name;
    sel.appendChild(opt);
  }
}

async function loadExtraCategories() {
  const snap = await get(ref(db, `${BASE}/config/categories`));
  const cats  = snap.val() || [];
  cats.forEach(addCategoryOption);
}

function syncCategoryDropdown() {
  // Ambil semua kategori: dari objek + dari config
  const fromObjects = [...new Set(allObjects.map(o => o.category).filter(Boolean))];
  const sel = document.getElementById("fCategory");
  const existing = Array.from(sel.options).map(o => o.value);

  // Tambah yang belum ada
  fromObjects.forEach(cat => {
    if (!existing.includes(cat)) addCategoryOption(cat);
  });

  // Hapus yang sudah tidak ada di objek maupun config
  get(ref(db, `${BASE}/config/categories`)).then(snap => {
    const configCats = snap.val() || [];
    const allValid   = [...new Set([...fromObjects, ...configCats])];
    Array.from(sel.options).forEach(opt => {
      if (!allValid.includes(opt.value)) opt.remove();
    });
  });
}


// ‚îÄ‚îÄ SYNC MASTER LIBRARY ‚îÄ‚îÄ
window.openSyncModal = async () => {
  const [masterObjSnap, masterUpdSnap] = await Promise.all([
    get(ref(db, "master/objects")),
    get(ref(db, "master/lastUpdated"))
  ]);
  const masterCount = masterObjSnap.exists() ? Object.keys(masterObjSnap.val()).length : 0;
  const lastUpd     = masterUpdSnap.val() ? new Date(masterUpdSnap.val()).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"}) : "‚Äî";

  document.getElementById("syncInfo").innerHTML = `
    <div style="display:flex;gap:20px;flex-wrap:wrap;">
      <div style="text-align:center;background:rgba(212,168,67,0.06);border:1px solid var(--border);border-radius:8px;padding:14px 20px;">
        <div style="font-family:'Cinzel',serif;font-size:24px;color:var(--gold2);">${masterCount}</div>
        <div style="font-size:10px;color:var(--dim);letter-spacing:2px;margin-top:4px;">OBJEK MASTER</div>
      </div>
      <div style="text-align:center;background:rgba(212,168,67,0.06);border:1px solid var(--border);border-radius:8px;padding:14px 20px;">
        <div style="font-family:'Cinzel',serif;font-size:24px;color:var(--gold2);">${allObjects.length}</div>
        <div style="font-size:10px;color:var(--dim);letter-spacing:2px;margin-top:4px;">OBJEK KAMU</div>
      </div>
      <div style="flex:1;min-width:160px;background:rgba(212,168,67,0.06);border:1px solid var(--border);border-radius:8px;padding:14px 20px;">
        <div style="font-size:11px;color:var(--dim);">Update master terakhir</div>
        <div style="font-family:'Cinzel',serif;font-size:13px;color:var(--gold2);margin-top:4px;">${lastUpd}</div>
      </div>
    </div>`;
  openModal("syncModal");
};

window.confirmSync = async () => {
  const mode       = document.getElementById("syncMode").value;
  const masterSnap = await get(ref(db, "master/objects"));
  if (!masterSnap.exists()) { toast("Master library kosong!", "error"); return; }

  const masterData = masterSnap.val();

  if (mode === "replace") {
    await set(ref(db, `${BASE}/objects`), masterData);
    toast(`‚úÖ ${Object.keys(masterData).length} objek dari master berhasil di-sync (replace)`, "success");
  } else {
    // Merge: hanya tambah yang namanya belum ada
    const existingNames = new Set(allObjects.map(o => o.name.toLowerCase()));
    let added = 0;
    for (const obj of Object.values(masterData)) {
      if (!existingNames.has((obj.name||"").toLowerCase())) {
        await push(ref(db, `${BASE}/objects`), obj);
        added++;
      }
    }
    toast(`‚úÖ ${added} objek baru ditambahkan dari master`, "success");
  }

  // Dismiss update notification
  await update(ref(db, `${BASE}/notifications`), { updateAvailable: false });
  document.getElementById("updateBanner").style.display = "none";
  closeModal("syncModal");
};

// ‚îÄ‚îÄ UPDATE BANNER ‚îÄ‚îÄ
async function checkUpdateNotif() {
  const snap = await get(ref(db, `${BASE}/notifications`));
  const notif = snap.val() || {};
  if (notif.updateAvailable) {
    const banner = document.getElementById("updateBanner");
    document.getElementById("updateBannerMsg").textContent = notif.updateMessage || "Ada objek baru dari admin!";
    banner.style.display = "flex";
  }
}

window.dismissUpdateBanner = async () => {
  await update(ref(db, `${BASE}/notifications`), { updateAvailable: false });
  document.getElementById("updateBanner").style.display = "none";
};

window.doSyncMaster = () => {
  closeModal && closeModal("syncModal");
  openSyncModal();
};


// ‚îÄ‚îÄ BULK DELETE ‚îÄ‚îÄ
let bulkMode    = false;
let selectedIds = new Set();

window.toggleBulkMode = () => {
  bulkMode = !bulkMode;
  selectedIds.clear();
  document.getElementById("bulkModeBtn").textContent = bulkMode ? "‚úï Batal Pilih" : "‚òë Pilih";
  document.getElementById("bulkModeBtn").style.color = bulkMode ? "var(--red2)" : "";
  document.documentElement.style.setProperty("--chk-display", bulkMode ? "block" : "none");
  document.getElementById("bulkBar").classList.toggle("show", bulkMode);
  updateBulkBar();
  renderList();
};

window.clearSelection = () => {
  bulkMode = false;
  selectedIds.clear();
  document.getElementById("bulkModeBtn").textContent = "‚òë Pilih";
  document.getElementById("bulkModeBtn").style.color = "";
  document.documentElement.style.setProperty("--chk-display", "none");
  document.getElementById("bulkBar").classList.remove("show");
  renderList();
};

window.toggleSelectAll = (checked) => {
  const start = (currentPage-1)*PER_PAGE;
  filtered.slice(start, start+PER_PAGE).forEach(obj => {
    if (checked) selectedIds.add(obj.id);
    else selectedIds.delete(obj.id);
  });
  updateBulkBar();
  renderList();
};

window.onCheckChange = (id, checked) => {
  if (checked) selectedIds.add(id);
  else selectedIds.delete(id);
  updateBulkBar();
};

window.handleCardClick = (e, id) => {
  if (bulkMode) {
    // Toggle checkbox
    const chk = document.getElementById("chk-"+id);
    if (chk) { chk.checked = !chk.checked; onCheckChange(id, chk.checked); }
  } else {
    toggleCard(id);
  }
};

function updateBulkBar() {
  const n = selectedIds.size;
  document.getElementById("bulkCount").textContent = n + " dipilih";
  // Sync selectAll checkbox
  const start = (currentPage-1)*PER_PAGE;
  const pageIds = filtered.slice(start, start+PER_PAGE).map(o=>o.id);
  const allChecked = pageIds.length > 0 && pageIds.every(id => selectedIds.has(id));
  const selAll = document.getElementById("selectAllCheck");
  if (selAll) { selAll.checked = allChecked; selAll.indeterminate = !allChecked && pageIds.some(id=>selectedIds.has(id)); }
}

window.bulkDelete = async () => {
  if (!selectedIds.size) return;
  const n = selectedIds.size;
  if (!confirm("Hapus " + n + " objek yang dipilih? Tindakan ini tidak bisa dibatalkan.")) return;

  const btn = document.querySelector(".bulk-actions .btn-danger");
  if (btn) { btn.disabled = true; btn.textContent = "Menghapus..."; }

  let done = 0;
  for (const id of Array.from(selectedIds)) {
    try {
      await remove(ref(db, BASE + "/objects/" + id));
      done++;
    } catch(e) { console.error("Gagal hapus", id, e); }
  }

  toast("üóë " + done + " objek berhasil dihapus", done === n ? "success" : "info");
  clearSelection();
};

// ‚îÄ‚îÄ CHANGE PIN ‚îÄ‚îÄ
window.openPinModal = () => {
  ["pinOld","pinNew","pinConfirm"].forEach(id=>document.getElementById(id).value="");
  openModal("pinModal");
};

window.doChangePin = async () => {
  const snap = await get(ref(db, `${BASE}/config/pin`));
  const stored = snap.val()||"1234";
  const old    = document.getElementById("pinOld").value;
  const nw     = document.getElementById("pinNew").value;
  const conf   = document.getElementById("pinConfirm").value;

  if (old !== stored)      { toast("PIN lama salah!", "error"); return; }
  if (nw.length !== 4)     { toast("PIN baru harus 4 digit!", "error"); return; }
  if (!/^\d{4}$/.test(nw)) { toast("PIN hanya boleh angka!", "error"); return; }
  if (nw !== conf)          { toast("Konfirmasi PIN tidak cocok!", "error"); return; }

  await set(ref(db, `${BASE}/config/pin`), nw);
  currentPin = nw;
  toast("‚úÖ PIN berhasil diubah", "success");
  closeModal("pinModal");
};

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
window.openModal  = (id) => document.getElementById(id).classList.add("open");
window.closeModal = (id) => document.getElementById(id).classList.remove("open");

// Close on overlay click
document.querySelectorAll(".modal-overlay").forEach(el => {
  el.addEventListener("click", e => { if(e.target===el) el.classList.remove("open"); });
});

function escHtml(s) {
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function toast(msg, type="info") {
  const c  = document.getElementById("toastContainer");
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(()=>el.remove(), 3200);
}

window.toast = toast;
</script>

</body>
</html>
